<project name="rhq_cassandra_bundle"
         default="main"
         xmlns:rhq="antlib:org.rhq.bundle">
  <rhq:bundle name="${rhq.cassandra.bundle.name}"
              version="${rhq.cassandra.bundle.version}"
              description="A bundle for deploying RHQ Cassandra nodes.">

    <!--
      NOTE: the name attribute of an rhq:input-property does not support using a dash.
      There is a convention where dashes are used in property names in rhq properties files
      in the trailing part of a property name. If an rhq:input-property has a corresponding
      property in cassandra.properties and contains a dash, the dash will be changed to an
      underscore in this file.
    -->

    <rhq:input-property name="cluster.name"
                        description="The name of the cluster. This is used to prevent machines in one logical cluster from joining another"
                        required="true"
                        defaultValue="rhqdev"
                        type="string"/>

    <rhq:input-property name="cluster.dir"
                        description="The directory in which Cassandra nodes will be installed"
                        required="true"
                        defaultValue=""
                        type="string"/>

    <rhq:input-property name="data.dir"
                        description="The directory where Cassandra should store data files. This should be a path relative to the base deployment directory."
                        required="true"
                        defaultValue="data"
                        type="string"/>
  
    <rhq:input-property name="commitlog.dir"
                        description="The directory where Cassandra stores its commit logs. This should be a path relative to the base deployment directory."
                        required="true"
                        defaultValue="commit_log"
                        type="string"/>

    <rhq:input-property name="saved.caches.dir"
                        description="The directory where Cassandra stores saved caches. This should be a path relative to the base deployment directory."
                        required="true"
                        defaultValue="saved_caches"
                        type="string"/>

    <rhq:input-property name="log.dir"
                        description="The directory where Cassandra stores log files. This should be a path relative to the base deployment directory."
                        required="false"
                        defaultValue="logs"
                        type="string"/>

    <rhq:input-property name="logging.level"
                        description="The log4j logging level to use."
                        required="false"
                        defaultValue="DEBUG"
                        type="string"/>

    <rhq:input-property name="hostname"
                        description="The host name of the node. This normally does not need to be set as Cassandra will resolve the host name/IP address. It needs to be set though for a local, development cluster running on a single machine."
                        required="true"
                        defaultValue="127.0.0.1"
                        type="string"/>

    <rhq:input-property name="seeds"
                        description="A comma-delimited list of IP addresses/host names that are deemed contact points. Cassandra nodes use this list of hosts to find each other and learn the topology of the ring. If you are running a local development cluster, be sure to have aliases set up for localhost."
                        required="false"
                        defaultValue="127.0.0.1"
                        type="string"/>

    <rhq:input-property name="rhq.cassandra.num_tokens"
                        description="Defines the number of tokens randomly assigned to a node on the ring. The more tokens, relative to other nodes, the larger the proportion of data that this node will store. You probably want all nodes to have the same number of tokens assuming they have equal hardware capability."
                        required="false"
                        defaultValue="256"
                        type="string"/>

    <rhq:input-property name="initial.token"
                        description="Each Cassandra node is assigned a unique token that determines what keys it is the first replica for. If you sort all nodes' token, the range of keys each is responsible for is (PreviousToken, MyToken], that is, from the previous token (exclusive) to the node's token (inclusive). The machine with the lowest Token gets both all keys less than that token, and all keys greater than the largest token; this is called a wrapping range."
                        required="false"
                        defaultValue=""
                        type="string"/>

    <rhq:input-property name="jmx.port"
                        description="The port over which Cassandra listens for JMX connections. Each node should be assigned a unique port."
                        required="false"
                        defaultValue="7200"
                        type="string"/>

    <rhq:input-property name="listen.address"
                        description="Address used for inter-node communication. Defaults to value of hostname property."
                        required="true"
                        defaultValue=""
                        type="string"/>

    <rhq:input-property name="rpc.address"
                        description="Address used for Thrift RPC client communication. Defaults to value of hostname property."
                        required="true"
                        defaultValue=""
                        type="string"/>

    <rhq:input-property name="cassandra.ring.delay.property"
                        required="false"
                        defaultValue=""
                        type="string"/>

    <rhq:input-property name="cassandra.ring.delay"
                        description="When a node initializes it contacts a seed and then sleeps for RING_DELAY (milliseconds) to learn about other nodes in the cluster. Cassandra uses a default value of 30 seconds."
                        required="false"
                        defaultValue=""
                        type="string"/>

    <rhq:input-property name="rhq.casandra.native_transport_max_threads"
                        description="The maximum number of threads handling native CQL requests."
                        required="false"
                        defaultValue="64"
                        type="integer"/>

    <rhq:input-property name="rhq.cassandra.native_transport_port"
                        description="The port for the CQL native transport to listen for clients on."
                        required="false"
                        defaultValue="9042"
                        type="integer"/>

    <rhq:input-property name="rhq.cassandra.rpc_port"
                        description="The port to listen for Thrift clients on."
                        required="false"
                        defaultValue="9160"
                        type="integer"/>

    <rhq:input-property name="rhq.cassandra.authenticator"
                        description="A class that performs authentication. The value should be a fully qualified class name and implement IAuthenticator."
                        required="false"
                        defaultValue="org.rhq.cassandra.auth.SimpleAuthenticator"
                        type="string"/>

    <rhq:input-property name="rhq.cassandra.authorizer"
                        description="A class that performs authorization. Used to limit/provide permissions. The value should be a fully qualified class name and implement IAuthorizer."
                        required="false"
                        defaultValue="org.rhq.cassandra.auth.SimpleAuthorizer"
                        type="string"/>

    <rhq:input-property name="rhq.cassandra.password.properties.file"
                        description="The location of the password properties file used by SimpleAuthenticator. If a relative path is specified, its location is resolved relative to Cassandra's bin directory."
                        required="false"
                        defaultValue="./../conf/passwd.properties"
                        type="file"/>

    <rhq:input-property name="rhq.cassandra.access.properties.file"
                        description="The location of the authorization properties file used by SimpleAuthority. If a relative path is specified, its location is resolved relative to Cassandra's bin directory."
                        required="false"
                        defaultValue="./../conf/access.properties"
                        type="file"/>

    <rhq:input-property name="rhq.cassandra.username"
                        description="The username with which to authenticate requests to Cassandra."
                        required="true"
                        type="string"/>

    <rhq:input-property name="rhq.cassandra.password"
                        description="The password with which to authenticate requests to Cassandra."
                        required="true"
                        type="string"/>

    <rhq:deployment-unit name="cassandra" preinstallTarget="pre-install" postinstallTarget="post-install">
<!--
      <rhq:file name="dbsetup.script" destinationFile="scripts/dbsetup.script" replace="true"/>
-->
      <rhq:archive name="cassandra.zip">
        <rhq:replace>
          <rhq:fileset dir="conf">
            <include name="cassandra.yaml"/>
          </rhq:fileset>
          <rhq:fileset dir="conf">
            <include name="cassandra-env.sh"/>
          </rhq:fileset>
          <rhq:fileset dir="conf">
            <include name="log4j-server.properties"/>
          </rhq:fileset>
          <rhq:fileset dir="conf">
            <include name="passwd.properties"/>
          </rhq:fileset>
<!--
          <rhq:fileset dir="scripts">
            <include name="dbsetup.script"/>
          </rhq:fileset>
-->
        </rhq:replace>
      </rhq:archive>
    </rhq:deployment-unit>
  </rhq:bundle>

  <target name="main"/>

  <target name="pre-install">
    <mkdir dir="${cluster.dir}"/>
  </target>

  <target name="post-install">
    <property name="bin.dir" value="${rhq.deploy.dir}/bin"/>

    <mkdir dir="${rhq.deploy.dir}/${data.dir}"/>
    <mkdir dir="${rhq.deploy.dir}/${commitlog.dir}"/>
    <mkdir dir="${rhq.deploy.dir}/${saved.caches.dir}"/>
    <mkdir dir="${rhq.deploy.dir}/${log.dir}"/>

    <chmod file="${bin.dir}/cassandra" perm="+x"/>
    <chmod file="${bin.dir}/cqlsh" perm="+x"/>
    <chmod file="${bin.dir}/cassandra-cli" perm="+x"/>
    <chmod file="${bin.dir}/nodetool" perm="+x"/>

<!--
    <exec dir="${bin.dir}" executable="cassandra" spawn="true" resolveexecutable="true"/>

    <script manager="javax" language="javascript"><![CDATA[
      if (project.getProperty("install.schema") == "true") {
        java.lang.Thread.sleep(1000 * 10);

        exec = project.createTask("exec");
        args = exec.createArg();
        args.setLine("-f ../scripts/dbsetup.script");
        exec.setDir(java.io.File(project.getProperty("bin.dir")));
        exec.setExecutable("cassandra-cli");
        exec.setResolveExecutable(true);
        exec.setError(java.io.File("/home/jsanda/cassandra.log"));
        exec.setOutput(java.io.File("/home/jsanda/cassandra.log"));

        exec.execute();
      }
    ]]></script>
-->
  </target>

</project>
