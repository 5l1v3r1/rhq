<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
  <changeSet id="0" author="jsanda">
    <createTable tableName="rhq_operation_def">
      <column name="id" type="integer">
        <constraints primaryKey="true" nullable="false"/>
      </column>   
      <column name="resource_type_id" type="integer">
        <constraints foreignKeyName="fk_resource_type_id_rhq_resource_type"
                     references="rhq_resource_type"
                     nullable="false"/>
      </column>         
      <column name="name" type="varchar(100)">
        <constraints nullable="false"/>
      </column>
      <!-- an OSGI version range - if null, the operation def applies to all versions of the associated resource type -->
      <column name="resource_version_range" type="varchar(100)"/>
      <!-- A parameter config definition is only required for operations that have parameters. -->
      <!-- A results config definition is only required for operations that return data. -->
      <column name="parameter_config_def_id" type="integer">
        <constraints foreignKeyName="fk_parameter_config_def_id_rhq_config_def"
                     references="rhq_config_def"/>
      </column>
      <column name="results_config_def_id" type="integer">
        <constraints foreignKeyName="fk_results_config_def_id_rhq_config_def"
                     references="rhq_config_def"/>
      </column>
      <column name="display_name" type="varchar(100)"/>
      <column name="description" type="varchar(4000)"/>
      <column name="timeout" type="integer"/>
    </createTable>
 
    <createSequence sequenceName="rhq_operation_def_id_seq" startValue="10001"/>

    <!-- === business key (RESOURCE_TYPE_ID + NAME) === -->
    <createIndex tableName="rhq_operation_def"
                 indexName="rhq_operation_def_key_idx"
                 unique="true">
      <column name="resource_type_id"/>
      <column name="name"/>
    </createIndex>
  </changeSet>

  <changeSet id="1" author="jsanda">
    <createTable tableName="rhq_operation_history">
      <column name="id" type="integer">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="dtype" type="varchar(8)">
        <constraints nullable="false"/>
      </column>
      <column name="job_name" type="varchar(100)">
        <constraints nullable="false"/>
      </column> 
      <column name="job_group" type="varchar(100)">
        <constraints nullable="false"/>
      </column>
      <column name="operation_def_id" type="integer">
        <constraints foreignKeyName="fk_operation_def_id_rhq_operation_def"
                     references="rhq_operation_def"
                     nullable="false"/>
      </column>
      <column name="status" type="varchar(16)">
        <constraints nullable="false"/>
      </column>
      <column name="error_message" type="longvarchar"/>
      <column name="subject_name" type="varchar(100)">
        <constraints nullable="false"/>
      </column> 
      <column name="ctime" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="stime" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="mtime" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="parameters_config_id" type="integer">
        <constraints foreignKeyName="fk_parameters_config_id_rhq_config"
                     references="rhq_config"/>        
      </column>
      <!-- for resource history -->
      <column name="resource_id" type="integer">
        <constraints foreignKeyName="fk_resource_id_rhq_resource"
                     references="rhq_resource"/>
      </column>
      <column name="results_config_id" type="integer">
        <constraints foreignKeyName="fk_results_config_id_rhq_config"
                     references="rhq_config"/>        
      </column>
      <column name="group_history_id" type="integer">
        <constraints foreignKeyName="fk_group_history_id_rhq_operation_history"
                     references="rhq_operation_history"/>
      </column>
      <column name="group_id" type="integer">
        <constraints foreignKeyName="fk_group_id_rhq_resource_group"
                     references="rhq_resource_group"/>
      </column>
    </createTable>

    <createSequence sequenceName="rhq_operation_history_id_seq" startValue="10001"/>

    <createIndex tableName="rhq_operation_history"
                 indexName="rhq_operation_history_job_idx">
      <column name="job_name"/>
      <column name="job_group"/>
      <column name="ctime"/>
    </createIndex>
  </changeSet>

  <!--
    This table is really just to support some specific use-cases.
    Specifically, to be able to get a list of histories for a specific schedule (aka quartz job)
    and to be able to query a list of all schedules along with their associated resource/group IDs
    possibly sorted by their next fire time.
    Note that a NULL next fire time means it won't fire again and the row is probaby about to be deleted;
    we can probably not even insert rows with NULL and make it a non-nullable field.  But rather than
    code special conditions into the session bean, we'll allow a short-lived NULL next fire time row.
    -->
  <changeSet id="2" author="jsanda">
    <createTable tableName="rhq_operation_schedule">
      <column name="job_name" type="varchar(100)">
        <constraints primaryKey="true"
                     primaryKeyName="rhq_operation_schedule_key"
                     nullable="false"/>
      </column>
      <column name="job_group" type="varchar(100)">
        <constraints primaryKey="true"
                     primaryKeyName="rhq_operation_schedule_key"
                     nullable="false"/>
      </column>
      <column name="dtype" type="varchar(8)">
        <constraints nullable="false"/>
      </column>
      <column name="next_fire_time" type="bigint"/>
      <!-- for resource history -->
      <column name="resource_id" type="integer">
        <constraints foreignKeyName="fk_resource_id_rhq_resource"
                     references="rhq_resource"/>
      </column>
      <!-- for group history -->
      <column name="group_id" type="integer">
        <constraints foreignKeyName="fk_group_id_rhq_resource_group"
                     references="rhq_resource_group"/>
      </column>
    </createTable>  
  </changeSet>
</databaseChangeLog>