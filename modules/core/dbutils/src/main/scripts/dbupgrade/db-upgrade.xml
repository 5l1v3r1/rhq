<?xml version="1.0"?>

<project name="db-upgrade" default="upgrade" basedir=".">

<!--
This target upgrades a database schema.  The parameters that it accepts are:
  jdbc.url              = the jdbc url of the database to upgrade
  jdbc.user             = the user to connect to the database as
  jdbc.password         = the database user's password
  target.schema.version = the schema version to upgrade to. If this is omitted
                          then the schema is upgraded to the latest version.

This target assumes that the taskdefs for the dbupgrade ant task have already been defined.
-->

<target name="upgrade">

<echo>
DB Upgrade:
   JDBC URL: ${jdbc.url}
   JDBC User: ${jdbc.user}
   Update Version: ${target.schema.version}
</echo>

<dbupgrade
   jdbcUrl="${jdbc.url}"
   jdbcUser="${jdbc.user}"
   jdbcPassword="${jdbc.password}"
   valueColumn="PROPERTY_VALUE"
   table="RHQ_SYSTEM_CONFIG"
   keyColumn="PROPERTY_KEY"
   keyMatch="DB_SCHEMA_VERSION"
   targetSchemaVersion="${target.schema.version}">

    <schemaSpec version="2.0">
        <!-- Empty initial schema to avoid install failure on default latest schema version -->
    </schemaSpec>
	
    <schemaSpec version="2.1">
        <!-- Keep the columnType VARCHAR2, but increase size;
            (see note for RHQ_ALERT_CONDITION table in alert-schema.xml for more info) -->
        <schema-alterColumn
            table="RHQ_ALERT_CONDITION"
            column="OPTION_STATUS" 
            columnType="VARCHAR2"
            precision="256" />
    </schemaSpec>
	
    <schemaSpec version="2.2">
        <!-- RHQ-481 make resource names longer -->
        <schema-alterColumn
            table="RHQ_RESOURCE"
            column="NAME" 
            columnType="VARCHAR2"
            precision="500" />
    </schemaSpec>

    <schemaSpec version="2.3">
        <!-- RHQ-666 - Don't require resource name at creation time -->
        <schema-alterColumn
            table="RHQ_CREATE_RES_HIST"
            column="CREATED_RESOURCE_NAME"
            columnType="VARCHAR2"
            precision="500"
           />
    </schemaSpec>

   <!-- RHQ-669 - Add metadata to package type to indicate architecture support -->
   <schemaSpec version="2.4">
        <schema-addColumn
            table="RHQ_PACKAGE_TYPE"
            column="SUPPORTS_ARCHITECTURE"
            columnType="BOOLEAN"
           />

        <schema-alterColumn
           table="RHQ_PACKAGE_TYPE"
           column="SUPPORTS_ARCHITECTURE"
           nullable="FALSE"
           />
   </schemaSpec>

   <!-- RHQ-176 - Add notes column to content requests -->
   <schemaSpec version="2.5">
        <schema-addColumn
            table="RHQ_CONTENT_REQ"
            column="NOTES"
            columnType="VARCHAR2"
            precision="512"/>
   </schemaSpec>


</dbupgrade>

</target>

</project>
