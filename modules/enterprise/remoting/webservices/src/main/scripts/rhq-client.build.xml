<?xml version="1.0" encoding="UTF-8"?>

<project name="rhq-client" basedir=".">

   <property name="jboss.home" location="${basedir}/target/jboss-${jboss.version}" />
   <property name="wsdl.home" location="${project.build.outputDirectory}/wsdl" />
   <property name="wsconsume.home" location="${project.build.outputDirectory}/wsconsume-output" />
   <property name="wsprovide.home" location="${project.build.outputDirectory}/wsprovide-output" />
   <property name="include.client.jar" value="true" />

   <target name="prepare-dist">
      <condition property="exclude.cli.jar" value="true">
         <equals arg1="${rhq.client.build.exclude.cli.jar}" arg2="true" />
      </condition>
      <condition property="include.client.jar" value="true">
         <equals arg1="${rhq.client.build.include.client.jar}" arg2="true" />
      </condition>

      <antcall target="prepare-jbossws" />
      <antcall target="prepare-wsdl" />
   </target>


   <!-- To generate the client service classes we need portions of an AS distribution that provide
	   jbossws.  Use a previous unzip if it is uptodate, in order to speed things up. -->
   <target name="prepare-jbossws">
      <property name="jboss.zip" location="${settings.localRepository}/org/jboss/jbossas/jboss-as-dist/${jboss.version}/jboss-as-dist-${jboss.version}.zip" />
      <condition property="jboss.uptodate">
         <and>
            <uptodate srcfile="${jboss.zip}" targetfile="${jboss.home}" />
            <available file="${jboss.home}/bin/wsprovide.bat" type="file" />
         </and>
      </condition>
      <antcall target="unzip-jboss" />
   </target>

   <target name="unzip-jboss" unless="jboss.uptodate">
      <unzip src="${settings.localRepository}/org/jboss/jbossas/jboss-as-dist/${jboss.version}/jboss-as-dist-${jboss.version}.zip" dest="${basedir}/target">
         <patternset>
            <include name="jboss-${jboss.version}/bin/ws*.*" />
            <include name="jboss-${jboss.version}/lib/*.jar" />
            <include name="jboss-${jboss.version}/lib/endorsed/*.jar" />
            <include name="jboss-${jboss.version}/client/*.jar" />
         </patternset>
      </unzip>
   </target>

   <target name="prepare-wsdl" if="include.client.jar">
      <echo>*** Creating new wsdl</echo>
      <mkdir dir="${wsconsume.home}" />
      <mkdir dir="${wsprovide.home}" />

      <!--  This classpath basically provides the environment the wsprovide script creates.  So,it's
         JBossws version specific (and assumes compatibility between JBossws and AS -->
      <path id="jbossws.native.classpath">
         <!-- java dependencies -->
         <fileset dir="${java.jre.home}/../lib/" includes="*.jar" />

         <!-- AS dependencies  -->
         <fileset dir="${jboss.home}/lib/endorsed/" includes="*.jar" />
         <fileset dir="${jboss.home}/lib/" includes="*.jar" />

         <!-- JBossws/AS client dependencies  -->
         <fileset dir="${jboss.home}/client">
            <include name="activation.jar" />
            <include name="getopt.jar" />
            <include name="jbossall-client.jar" />
            <include name="jbossws-client.jar" />
            <include name="log4j.jar" />
            <include name="mail.jar" />
            <include name="jaxb-api.jar" />
            <include name="jaxb-impl.jar" />
            <include name="jaxb-xjc.jar" />
            <include name="jaxws-tools.jar" />
            <include name="jaxws-rt.jar" />
            <include name="streambuffer.jar" />
            <include name="stax-ex.jar" />
            <include name="javassist.jar" />
            <include name="jboss-xml-binding.jar" />
            <include name="jboss-jaxws.jar" />
            <include name="jboss-jaxrpc.jar" />
            <include name="jboss-saaj.jar" />
            <include name="policy.jar" />
            <include name="wsdl4j.jar" />
            <include name="jbossws-spi.jar" /> <!-- for the wsprovide and wsconsume ant tasks -->
         </fileset>

         <!-- Oddball dependency that seems needed but missing -->
         <fileset dir="${settings.localRepository}/javax/persistence/persistence-api/${persistence-api.version}/">
            <include name="persistence-api-${persistence-api.version}.jar" />
         </fileset>

         <!--  Add support for wsconsume -->
         <fileset dir="${jboss.home}/client">
            <include name="wstx.jar" />
            <include name="stax-api.jar" />
            <include name="stax-ex.jar" />
         </fileset>
      </path>

      <taskdef name="wsprovide" classname="org.jboss.wsf.spi.tools.ant.WSProvideTask" classpathref="jbossws.native.classpath" />
      <taskdef name="wsconsume" classname="org.jboss.wsf.spi.tools.ant.WSConsumeTask" classpathref="jbossws.native.classpath" />

      <echo>*** Providing ChannelManagerRemote wsdl...</echo>
      <wsprovide fork="true" destdir="${wsprovide.home}" resourcedestdir="${wsdl.home}" genwsdl="true" sei="org.rhq.enterprise.server.content.ChannelManagerBean">
         <classpath>
            <pathelement path="${maven.runtime.classpath}" />
         </classpath>
      </wsprovide>

      <echo>*** Providing ConfigurationManagerRemote wsdl...</echo>
      <wsprovide fork="true" destdir="${wsprovide.home}" resourcedestdir="${wsdl.home}" genwsdl="true" sei="org.rhq.enterprise.server.configuration.ConfigurationManagerBean">
         <classpath>
            <pathelement path="${maven.runtime.classpath}" />
         </classpath>
      </wsprovide>

      <echo>*** Providing ContentManagerRemote wsdl...</echo>
      <wsprovide fork="true" destdir="${wsprovide.home}" resourcedestdir="${wsdl.home}" genwsdl="true" sei="org.rhq.enterprise.server.content.ContentManagerBean">
         <classpath>
            <pathelement path="${maven.runtime.classpath}" />
         </classpath>
      </wsprovide>

      <echo>*** Providing OperationManagerRemote wsdl...</echo>
      <wsprovide fork="true" destdir="${wsprovide.home}" resourcedestdir="${wsdl.home}" genwsdl="true" sei="org.rhq.enterprise.server.operation.OperationManagerBean">
         <classpath>
            <pathelement path="${maven.runtime.classpath}" />
         </classpath>
      </wsprovide>

      <echo>*** Providing ResourceManagerRemote wsdl...</echo>
      <wsprovide fork="true" destdir="${wsprovide.home}" resourcedestdir="${wsdl.home}" genwsdl="true" sei="org.rhq.enterprise.server.resource.ResourceManagerBean">
         <classpath>
            <pathelement path="${maven.runtime.classpath}" />
         </classpath>
      </wsprovide>

      <echo>*** Providing RoleManagerRemote wsdl...</echo>
      <wsprovide fork="true" destdir="${wsprovide.home}" resourcedestdir="${wsdl.home}" genwsdl="true" sei="org.rhq.enterprise.server.authz.RoleManagerBean">
         <classpath>
            <pathelement path="${maven.runtime.classpath}" />
         </classpath>
      </wsprovide>

      <echo>*** Providing SubjectManagerRemote wsdl...</echo>
      <wsprovide fork="true" destdir="${wsprovide.home}" resourcedestdir="${wsdl.home}" genwsdl="true" sei="org.rhq.enterprise.server.auth.SubjectManagerBean">
         <classpath>
            <pathelement path="${maven.runtime.classpath}" />
         </classpath>
      </wsprovide>

      <echo>*** Consuming ChannelManagerRemote wsdl...</echo>
      <wsconsume fork="true" package="org.rhq.enterprise.server.ws" destdir="${wsconsume.home}" wsdl="${wsdl.home}/ChannelManagerBeanService.wsdl" />

      <echo>*** Consuming ContentManagerRemote wsdl...</echo>
      <wsconsume fork="true" package="org.rhq.enterprise.server.ws" destdir="${wsconsume.home}" wsdl="${wsdl.home}/ContentManagerBeanService.wsdl" />

      <echo>*** Consuming ConfigurationManagerRemote wsdl...</echo>
      <wsconsume fork="true" package="org.rhq.enterprise.server.ws" destdir="${wsconsume.home}" wsdl="${wsdl.home}/ConfigurationManagerBeanService.wsdl" />

      <echo>*** Consuming OperationManagerRemote wsdl...</echo>
      <wsconsume fork="true" package="org.rhq.enterprise.server.ws" destdir="${wsconsume.home}" wsdl="${wsdl.home}/OperationManagerBeanService.wsdl" />

      <echo>*** Consuming ResourceManagerRemote wsdl...</echo>
      <wsconsume fork="true" package="org.rhq.enterprise.server.ws" destdir="${wsconsume.home}" wsdl="${wsdl.home}/ResourceManagerBeanService.wsdl" />

      <echo>*** Consuming RoleManagerRemote wsdl...</echo>
      <wsconsume fork="true" package="org.rhq.enterprise.server.ws" destdir="${wsconsume.home}" wsdl="${wsdl.home}/RoleManagerBeanService.wsdl" />

      <echo>*** Consuming SubjectManagerRemote wsdl...</echo>
      <wsconsume fork="true" package="org.rhq.enterprise.server.ws" destdir="${wsconsume.home}" wsdl="${wsdl.home}/SubjectManagerBeanService.wsdl" />
   </target>

</project>
