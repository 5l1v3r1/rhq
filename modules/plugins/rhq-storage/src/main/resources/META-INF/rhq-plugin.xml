<plugin
  name="RHQStorage"
  displayName="RHQ Storage"
  package="org.rhq.plugins.storage"
  description="Monitoring of RHQ Storage features and performance"
  xmlns="urn:xmlns:rhq-plugin"
  xmlns:c="urn:xmlns:rhq-configuration">

  <depends plugin="Cassandra" useClasses="true" />

  <server
    name="RHQ Storage Node"
    discovery="StorageNodeDiscoveryComponent"
    class="StorageNodeComponent"
    description="RHQ Storage Node">

    <subcategories>
      <subcategory name="Client Request Metrics" description="Client Request Metrics"/>
      <subcategory name="Server Request Metrics" description="Server Request Metrics"/>
      <subcategory name="Internal Server Metrics" description="Internal Server Metrics"/>
      <subcategory name="Database Management Services" description="Database Management Services"/>
      <subcategory name="Network Services" description="Network Services"/>
    </subcategories>

    <plugin-configuration>
      <c:simple-property name="connectorAddress" displayName="Manager URL" default="service:jmx:rmi:///jndi/rmi://localhost:7199/jmxrmi"
                         description="The RMI URL with which to connect to the Cassandra node (e.g. service:jmx:rmi:///jndi/rmi://localhost:7199/jmxrmi)."/>
      <c:simple-property name="type" readOnly="true" default="org.mc4j.ems.connection.support.metadata.J2SE5ConnectionTypeDescriptor"
                         description="The type used to establish the EMS connection to the Cassandra node."/>
      <c:simple-property name="username" default="rhqadmin" required="true" description="The login username"/>
      <c:simple-property name="password" default="rhqadmin" required="true" type="password" description="The login password"/>
      <c:simple-property name="baseDir" displayName="Base Directory" description="The base directory from which the Cassandra Daemon was launched." required="false"/>
      <c:simple-property name="yamlConfiguration" displayName="YAML Configuration File" description="YAML Configuration File"/>
      <c:simple-property name="nativeTransportPort" description="The port on which Cassandra listens for CQL client connections." default="9042" type="integer"/>
      <c:simple-property name="host" description="The host on which cassandra listens to CQL client connections" default="localhost"/>
      <c:simple-property name="clusterName" description="Cluster name" default="localhost"/>
      <c:simple-property name="authenticator" required="true" default="org.apache.cassandra.auth.AllowAllAuthenticator" description="Cassandra client authenticator">
        <c:property-options>
          <c:option name="org.apache.cassandra.auth.AllowAllAuthenticator" value="org.apache.cassandra.auth.AllowAllAuthenticator"/>
          <c:option name="org.apache.cassandra.auth.PasswordAuthenticator" value="org.apache.cassandra.auth.PasswordAuthenticator"/>
        </c:property-options>
      </c:simple-property>
      <c:simple-property name="commandLine" required="false" type="string" description="the command line of the JVM at the time it was discovered - only used by JVMs with type Local; if the command line of the JVM changes, this property's value will need to be updated accordingly in order for RHQ to connect to the JVM"/>
    </plugin-configuration>

    <process-scan name="CassandraDaemon" query="process|basename|match=^java.*,arg|org.apache.cassandra.service.CassandraDaemon|match=.*"/>

    <operation name="shutdown" description="Shuts down the Cassandra daemon">
      <results>
        <c:simple-property name="shutdownResult" description="Shutdown the Cassandra daemon"/>
      </results>
    </operation>

    <operation name="start" description="Starts the Cassandra daemon">
      <results>
        <c:simple-property name="startResult" description="Start the Cassandra daemon"/>
      </results>
    </operation>
    <operation name="restart" description="Restarts the Cassandra daemon">
      <results>
        <c:simple-property name="startResult" description="Restart the Cassandra daemon"/>
      </results>
    </operation>

    <operation name="readRepair" description="Runs read repair on primar range of rhq and system_auth keyspaces">
      <results>
        <c:list-property name="results">
          <c:map-property name="resultsMap">
          <c:simple-property name="task" type="string"/>
          <c:simple-property name="succeeded" type="boolean"/>
          <c:simple-property name="details" type="string"/>
        </c:map-property>
        </c:list-property>
      </results>
    </operation>
    
    <operation name="addNodeMaintenance">
      <parameters>
        <c:simple-property name="runRepair" type="boolean" default="true"/>
        <c:simple-property name="updateSeedsList" type="boolean" default="true"/>
        <c:list-property name="seedsList">
          <c:simple-property name="seed" type="string"/>
        </c:list-property>
      </parameters>
      <results>
        <c:list-property name="results">
          <c:map-property name="resultsMap">
            <c:simple-property name="task" type="string"/>
            <c:simple-property name="succeeded" type="boolean"/>
            <c:simple-property name="details" type="string"/>
          </c:map-property>
        </c:list-property>
      </results>
    </operation>

    <operation name="prepareForUpgrade" description="Prepares the storage node for upgrade (this operation consists of following steps: 1) turning off the RPC server, 2) turning off the gossiper, 3) taking the snapshot (backuping the data), 4) invoking the drain operation">
        <parameters>
          <c:simple-property name="snapshotName" required="false" type="string" displayName="Snapshot Name"
                             description="Snapshot name. If left empty current system time in milliseconds will be used as the snapshot name."/>
        </parameters>
        <results>
          <c:simple-property name="prepareForUpgradeResult" description="Prepares the storage node for upgrade (this operation consists of following steps: 1) turning off the RPC server, 2) turning off the gossiper, 3) taking the snapshot (backuping the data), 4) invoking the drain operation"/>
        </results>
    </operation>

    <operation name="updateSeedsList" description="Updatess the node's seeds property in cassandra.yaml">
      <parameters>
        <c:list-property name="seedsList">
          <c:simple-property name="seed" type="string"/>
        </c:list-property>
      </parameters>
    </operation>

    <resource-configuration>
      <c:group name="MemorySettings">
        <c:simple-property name="minHeapSize"
                           readOnly="true"
                           description="The minimum heap size. This value will be used with the -Xms JVM option. This
                           is read only because it is automatically set to the same value as Max Heap Size."/>
        <c:simple-property name="maxHeapSize"
                           description="The maximum heap size. This value will be used with the -Xmx JVM option. The
                           value should be an integer with a suffix of M or G to indicate megabytes or gigabytes.">
          <c:constraint>
            <c:regex-constraint expression="\d+[mMgG]"/>
          </c:constraint>
        </c:simple-property>
        <c:simple-property name="heapNewSize"
                           description="The size of the new generation portion of the heap. This value will be used with
                           the -Xmn JVM option. The value should be an integer with a suffix of M or G to indicate
                           megabytes or gigabytes.">
          <c:constraint>
            <c:regex-constraint expression="\d+[mMgG]"/>
          </c:constraint>
        </c:simple-property>
        <c:simple-property name="threadStackSize"
                           type="integer"
                           description="The thread stack size. This memory is allocated to each thread off heap. The
                           value should be an integer that will be interpreted in kilobytes."/>
        <c:simple-property name="heapDumpOnOOMError" displayName="Heap Dump on OutOfMemoryError" type="boolean"
                           default="true"
                           description="Generate a heap dump when an OutOfMemoryError occurs"/>
        <c:simple-property name="heapDumpDir" displayName="Heap Dump Directory" required="false"
                           description="The directory in which heap dumps will be written."/>
      </c:group>
    </resource-configuration>

    <server name="Cassandra Server JVM"
            sourcePlugin="JMX" sourceType="JMX Server"
            discovery="org.rhq.plugins.jmx.EmbeddedJMXServerDiscoveryComponent"
            class="org.rhq.plugins.jmx.EmbeddedJMXServerComponent"
            description="The JVM of the Cassandra node"
            singleton="true">

      <plugin-configuration>
        <c:simple-property name="type" type="string" default="PARENT" readOnly="true" description="The EMS connection type for this JVM (cannot be modified)"/>
      </plugin-configuration>
    </server>

    <service name="StorageProxy" sourcePlugin="Cassandra" sourceType="StorageProxy" singleton="true"/>

    <service name="StorageService" sourcePlugin="Cassandra" sourceType="StorageService" singleton="true"/>

    <service name="CommitLog" sourcePlugin="Cassandra" sourceType="CommitLog" singleton="true"/>

    <service name="ReadTimeouts" sourcePlugin="Cassandra" sourceType="ReadTimeouts" singleton="true"/>

    <service name="ReadUnavailables" sourcePlugin="Cassandra" sourceType="ReadUnavailables" singleton="true"/>

    <service name="WriteTimeouts" sourcePlugin="Cassandra" sourceType="WriteTimeouts" singleton="true"/>

    <service name="WriteUnavailables" sourcePlugin="Cassandra" sourceType="WriteUnavailables" singleton="true"/>

    <service name="CompactionManager" sourcePlugin="Cassandra" sourceType="CompactionManager" singleton="true"/>

    <service name="CacheService" sourcePlugin="Cassandra" sourceType="CacheService" singleton="true"/>

    <service name="ConfigurableStages" sourcePlugin="Cassandra" sourceType="ConfigurableStages" singleton="true"/>

    <service name="EnabledStages" sourcePlugin="Cassandra" sourceType="EnabledStages" singleton="true"/>

    <service name="ConfigurableInternalServerMetrics" sourcePlugin="Cassandra" sourceType="ConfigurableInternalServerMetrics"
             singleton="true"/>

    <service name="EnabledInternalServerMetrics" sourcePlugin="Cassandra" sourceType="EnabledInternalServerMetrics"
             singleton="true"/>

    <service name="FailureDetector" sourcePlugin="Cassandra" sourceType="FailureDetector" singleton="true"/>

    <service name="Gossiper" sourcePlugin="Cassandra" sourceType="Gossiper" singleton="true"/>

    <service name="StreamingService" sourcePlugin="Cassandra" sourceType="StreamingService" singleton="true"/>

    <service name="MessagingService" sourcePlugin="Cassandra" sourceType="MessagingService" singleton="true"/>

    <service name="Keyspace" sourcePlugin="Cassandra" sourceType="Keyspace"/>
  </server>
</plugin>
